<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¬¬3é—œï¼šå°‹æ‰¾éºå¤±ç‰©å“</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      color: #eee;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #game-canvas {
      display: block;
      background: #7b9acc;
    }
    #start-screen, #end-screen {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      z-index: 10;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 20px;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: #fff;
      user-select: none;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

<canvas id="game-canvas"></canvas>

<div id="start-screen">
  <p>è«‹å”åŠ©è€äººå°‹æ‰¾ 10 ä»¶éºå¤±çš„ç‰©å“ï¼</p>
  <p>é¿é–‹å±éšªå€ï¼ˆâ›”ï¼‰ï¼Œç”¨éµç›¤æ–¹å‘éµ â† â†’ â†‘ â†“ æ§åˆ¶è€äººç§»å‹•ã€‚</p>
  <button id="start-btn">é–‹å§‹éŠæˆ²</button>
</div>

<div id="end-screen" style="display: none;">
  <p id="end-message"></p>
  <button id="retry-btn">é‡æ–°æŒ‘æˆ°</button>
  <button id="next-btn" style="display: none;">å‰å¾€ä¸‹ä¸€é—œ</button>
</div>

<script>
(() => {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  const startScreen = document.getElementById('start-screen');
  const endScreen = document.getElementById('end-screen');
  const startBtn = document.getElementById('start-btn');
  const retryBtn = document.getElementById('retry-btn');
  const nextBtn = document.getElementById('next-btn');
  const endMessage = document.getElementById('end-message');

  // èƒŒæ™¯éŸ³æ¨‚
  const bgm = new Audio("images/music.mp3");
  bgm.loop = true;
  bgm.volume = 0.5;

  let gameWidth = window.innerWidth;
  let gameHeight = window.innerHeight;
  canvas.width = gameWidth;
  canvas.height = gameHeight;

  const player = { x: 100, y: 100, size: 48, speed: 4 };
  const items = [];
  const dangerZones = [];
  const keysPressed = {};
  const totalItems = 10;

  // ç‰©å“è¡¨æƒ…åº«ï¼Œå¤šæ¨£åŒ–
  const itemEmojis = ["ğŸ‘“", "ğŸ“–", "ğŸ’Š", "ğŸ“·", "ğŸ§£", "ğŸ§¤", "ğŸ§¥", "ğŸ©º", "ğŸªª", "ğŸ“”", "ğŸ“", "ğŸª™", "ğŸ§³"];

  // èª¿æ•´ç•«å¸ƒå¤§å°æ™‚åŒæ­¥æ›´æ–°
  window.addEventListener('resize', () => {
    gameWidth = window.innerWidth;
    gameHeight = window.innerHeight;
    canvas.width = gameWidth;
    canvas.height = gameHeight;
  });

  // åµæ¸¬éµç›¤æŒ‰éµç‹€æ…‹
  window.addEventListener('keydown', e => keysPressed[e.key] = true);
  window.addEventListener('keyup', e => keysPressed[e.key] = false);

  function resetPlayer() {
    player.x = gameWidth / 2;
    player.y = gameHeight - 100;
  }

  // ç”¢ç”Ÿéš¨æ©Ÿç‰©å“
  function spawnItems() {
    items.length = 0;
    const itemPool = [...itemEmojis, ...itemEmojis];
    const count = 20 + Math.floor(Math.random() * 10); // 20ï½30å€‹ç‰©å“ä¾›é¸
    for (let i = 0; i < count; i++) {
      const emoji = itemPool[Math.floor(Math.random() * itemPool.length)];
      items.push({
        x: Math.random() * (canvas.width - 30),
        y: Math.random() * (canvas.height - 100),
        emoji: emoji,
        collected: false,
      });
    }
  }

  // ç”¢ç”Ÿå±éšªå€å¡Š
  function spawnDangerZones() {
    dangerZones.length = 0;
    for (let i = 0; i < 5; i++) {
      dangerZones.push({
        x: Math.random() * (canvas.width - 60),
        y: Math.random() * (canvas.height - 60),
        width: 60,
        height: 60
      });
    }
  }

  // ç¹ªè£½éŠæˆ²å…ƒç´ 
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // â›” å±éšªå€
    dangerZones.forEach(zone => {
      ctx.font = "48px sans-serif";
      ctx.fillText("â›”", zone.x, zone.y + 40);
    });

    // ğŸ‘´ ç©å®¶
    ctx.font = "48px sans-serif";
    ctx.fillText("ğŸ‘´ğŸ»", player.x, player.y + player.size);

    // ğŸ§³ ç‰©å“
    items.forEach(item => {
      if (!item.collected) {
        ctx.font = "36px sans-serif";
        ctx.fillText(item.emoji, item.x, item.y + 30);
      }
    });

    // å·²æ”¶é›†ç‰©å“è¨ˆæ•¸
    const collectedCount = items.filter(i => i.collected).length;
    ctx.fillStyle = "#fff";
    ctx.font = "20px Arial";
    ctx.fillText(`å·²æ”¶é›†ï¼š${collectedCount}/${totalItems}`, 20, 30);
  }

  // æ›´æ–°éŠæˆ²ç‹€æ…‹
  function update() {
    if (keysPressed['ArrowLeft']) player.x -= player.speed;
    if (keysPressed['ArrowRight']) player.x += player.speed;
    if (keysPressed['ArrowUp']) player.y -= player.speed;
    if (keysPressed['ArrowDown']) player.y += player.speed;

    player.x = Math.max(0, Math.min(canvas.width - player.size, player.x));
    player.y = Math.max(0, Math.min(canvas.height - player.size, player.y));

    // åˆ¤æ–·ç¢°åˆ°å±éšªå€
    for (const zone of dangerZones) {
      if (
        player.x < zone.x + zone.width &&
        player.x + player.size > zone.x &&
        player.y < zone.y + zone.height &&
        player.y + player.size > zone.y
      ) {
        endGame(false);
        return;
      }
    }

    // æ”¶é›†ç‰©å“åˆ¤æ–·
    for (const item of items) {
      if (!item.collected &&
          Math.abs(player.x - item.x) < 40 &&
          Math.abs(player.y - item.y) < 40) {
        item.collected = true;
      }
    }

    // éé—œåˆ¤å®š
    const collected = items.filter(i => i.collected).length;
    if (collected >= totalItems) {
      endGame(true);
    }
  }

  // éŠæˆ²ä¸»è¿´åœˆ
  function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  // é–‹å§‹éŠæˆ²åˆå§‹åŒ–
  function startGame() {
    resetPlayer();
    spawnItems();
    spawnDangerZones();
    gameLoop();
    bgm.play();
    startScreen.style.display = "none";
    endScreen.style.display = "none";
  }

  // çµæŸéŠæˆ²é¡¯ç¤ºçµæœ
  function endGame(success) {
    endScreen.style.display = "flex";
    endMessage.textContent = success
      ? "æ­å–œï¼ä½ æˆåŠŸæ‰¾å› 10 ä»¶éºå¤±ç‰©å“ï¼"
      : "ä½ é€²å…¥äº†å±éšªå€ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
    nextBtn.style.display = success ? "inline-block" : "none";
    bgm.pause();
    bgm.currentTime = 0;
  }

  startBtn.onclick = startGame;
  retryBtn.onclick = startGame;
 nextBtn.onclick = () => window.location.href = "level4.html";
})();
</script>

</body>
</html>
